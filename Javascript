// Configuration
const CORS_PROXY = 'https://api.allorigins.win/raw?url=';  // Free CORS proxy
const DEFAULT_HOME_URL = 'https://www.example.com'; // Home page to load by default

// DOM elements
const searchInput = document.getElementById('searchInput');
const searchButton = document.getElementById('searchButton');
const loadingPopup = document.getElementById('loadingPopup');
const loadingText = document.getElementById('loadingText');
const tabsContainer = document.getElementById('tabs');
const tabContent = document.getElementById('tabContent');

// Active tab tracking
let activeTab = null;
let tabIndex = 0;
const tabs = [];

// Show loading screen
function showLoading(text = 'Loading...') {
  loadingText.innerText = text;
  loadingPopup.style.display = 'flex';
}

// Hide loading screen
function hideLoading() {
  loadingPopup.style.display = 'none';
}

// Create a new tab with the specified URL
function createTab(url) {
  const tabId = `tab-${tabIndex++}`;
  const tab = document.createElement('div');
  tab.classList.add('tab');
  tab.setAttribute('data-tab-id', tabId);
  tab.innerHTML = `<span>${url}</span><button class="close-tab">X</button>`;
  tabsContainer.appendChild(tab);

  // Close tab functionality
  const closeButton = tab.querySelector('.close-tab');
  closeButton.addEventListener('click', () => {
    closeTab(tabId);
  });

  // Handle tab click to switch to this tab
  tab.addEventListener('click', () => {
    switchTab(tabId);
  });

  tabs.push({ id: tabId, url: url });
  switchTab(tabId);
}

// Switch to the clicked tab
function switchTab(tabId) {
  // Deactivate the current tab
  if (activeTab) {
    const activeTabElement = document.querySelector(`.tab[data-tab-id="${activeTab}"]`);
    activeTabElement.classList.remove('active');
  }

  // Activate the clicked tab
  activeTab = tabId;
  const newTabElement = document.querySelector(`.tab[data-tab-id="${tabId}"]`);
  newTabElement.classList.add('active');

  // Load the content of the tab (the website)
  const tab = tabs.find(tab => tab.id === tabId);
  loadTabContent(tab.url);
}

// Load the content of the selected tab in an iframe
function loadTabContent(url) {
  showLoading('Loading content...');
  tabContent.innerHTML = `<iframe src="${CORS_PROXY + encodeURIComponent(url)}" sandbox="allow-forms allow-same-origin allow-popups allow-popups-to-escape-sandbox"></iframe>`;
  hideLoading();
}

// Close a tab
function closeTab(tabId) {
  const tab = document.querySelector(`.tab[data-tab-id="${tabId}"]`);
  if (tab) {
    tab.remove();
  }
  const tabIndexToRemove = tabs.findIndex(tab => tab.id === tabId);
  if (tabIndexToRemove !== -1) {
    tabs.splice(tabIndexToRemove, 1);
  }

  // If the closed tab was active, switch to another tab
  if (activeTab === tabId && tabs.length > 0) {
    switchTab(tabs[0].id);
  }
}

// Handle the search button click event (to load the URL)
searchButton.addEventListener('click', () => {
  const query = searchInput.value.trim();
  if (query) {
    // Validate and load the URL
    if (isValidUrl(query)) {
      createTab(query);
    } else {
      alert('Invalid URL');
    }
  }
  searchInput.value = ''; // Clear the input field after search
});

// Check if the entered string is a valid URL
function isValidUrl(str) {
  try {
    new URL(str);  // Try to construct a URL object
    return true;
  } catch (e) {
    return false;
  }
}

// Initialize the app with a default home tab
createTab(DEFAULT_HOME_URL);

